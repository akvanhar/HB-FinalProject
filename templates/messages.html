{% extends 'base.html' %}
{% block content %}
<script>
	$("#messagesButton").attr("class", 'active');
</script>

<h3>New Messages:</h3>
<div id="messageSent" class="alert alert-success" role="alert" style="display: none"></div>
{% if all_messages %}
	<table class="table table-condensed table-hover">
		<thead>
			<tr>
				<th>Date Sent:</th>
				<th>Message From:</th>
				<th>Message</th>
				<th></th>
				<th></th>
			</tr>
		</thead>
		<tbody id="messageTable">
			{% for message in all_messages %}
				<tr class='user-message' id='message{{ message.message_id }}'>
					<td>{{ message.datetime_sent.strftime("%b %d, %Y") }}</td>
					<td>{{ message.user.fname }} {{ message.user.lname }}</td>
					<td>{{ message.message_sent }}</td>
					<td>
						<button data-id = "reply{{message.message_id}}" class="replyButton btn btn-sm" data-toggle="modal" data-target="#myModal{{message.message_id}}">Reply</button>
						<div class="replyModal modal fade" data-id="myModal{{message.message_id}}" tabindex="-1" role="dialog">
							<div class="modal-dialog" role="document">
    							<div class="modal-content">
        							<div class="modal-header">
            							<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            							<h1 data-id="header{{message.message_id}}" class="modalHeader modal-title">Reply to {{ message.user.fname }}:</h1>
        							</div>
    								<div class="modal-body">
    									<p>Original message: {{ message.message_sent }}</p>
    									<form action="/reply_to_message" methods="post" class="modalForm" data-id='replyTo{{ message.message_id }}'>
        									<input class="modalUser" data-id="modalUser{{message.message_id}}" type="hidden" name="send_message_to" value="{{ message.user.user_id }}">
											<textarea class="modalTextArea" data-id="message{{message.message_id}}" name='message' rows='10' cols='75'></textarea>
    								</div>
    								<div class="modal-footer">
        								<button class="modalCancel btn btn-default" data-dismiss="modal">Cancel</button>
        								<button class="modalSubmit btn btn-primary pull-right" data-id='submit{{ message.message_id }}'>Reply</button>	
    								</div>
    								</form>
								</div>
							</div>
						</div>
					</td>
					<td><button class="deleteButton btn btn-sm" data-id='delete{{ message.message_id }}'>Delete</button></td>
					{% if message.read_status == 0%}
						<td><button data-id='read{{ message.message_id }}' class="readButton btn btn-sm">Mark as read</button></td>
					{% else %}
						<td><button data-id='unread{{ message.message_id }}' class="unreadButton btn btn-sm">Mark as unread</button></td>
					{% endif %}
				</tr>
				<script>
					// function reply(evt) {
					// 	//submit the form to the server and close the modal window
					// 	evt.preventDefault();
					// 	message_info = $("#replyTo{{ message.message_id }}").serialize();
					// 	$.post("/reply_to_message", message_info, function (result) {
					// 	//Display a success message
					// 		$("#modalUser{{message.message_id}}").val("");
					// 		$("#message{{message.message_id}}").html("");
					// 		$("#myModal{{message.message_id}}").modal('hide');
					// 		$('.modal-backdrop').fadeOut(50);
					// 		$("#messageSent").html('');
					// 		$("#messageSent").css("display", "block");
					// 		$("#messageSent").html(result);
					// 		$("#messageSent").delay(5000).fadeOut();
					// 	});//close the Ajax call
					// }//close the reply function

					// $('#submit{{ message.message_id }}').click(reply);

					function markAsRead(evt) {
						var message_id = { message_id: {{ message.message_id }} };
						$.post("/mark_as_read", message_id, function (result) {
							$("#messageSent").html('');
							$("#messageSent").css("display", "block");
							$("#messageSent").html('Your message has been marked as unread.');
							$("#messageSent").delay(5000).fadeOut();
							var readMessage = $("#message{{ message.message_id }}");
							$("#messageTable").append(readMessage);
							$("#message{{ message.message_id }}").remove();
						});
					}

					$('#readButton{{ message.message_id }}').click(markAsRead);

					function markAsUnread(evt) {
						var message_id = { message_id: {{ message.message_id }} };
						$.post("/mark_as_unread", message_id, function (result) {
							$("#messageSent").html('');
							$("#messageSent").css("display", "block");
							$("#messageSent").html('Your message has been marked as unread.');
							$("#messageSent").delay(5000).fadeOut();
							$("#message{{ message.message_id }}").css("font-weight", "bold");
						});
					}

					$('#unreadButton{{ message.message_id }}').click(markAsUnread);
				</script>
			{% endfor %}

		</tbody>
	</table>
{% else %}
	<p>You have new messages</p>
{% endif %}
<script>
	function deleteMessage(evt) {
		//delete the user message and display success message
		targetMessage = $(evt.currentTarget).data().id;
		var thisMessage = targetMessage.slice(6);
		var messageId = { message_id: targetMessage.slice(6) };
		$.post("/delete_message", messageId, function (result) {
			$("#messageSent").html('');
			$("#messageSent").css("display", "block");
			$("#messageSent").html('Your message has been deleted.');
			$("#messageSent").delay(5000).fadeOut();
			$("#message"+thisMessage).remove();
			});
	}
	$('.deleteButton').click(deleteMessage);

	function reply(evt) {
		//submit the form to the server and close the modal window
		evt.preventDefault();
		message_info = $("#replyTo{{ message.message_id }}").serialize();
		$.post("/reply_to_message", message_info, function (result) {
		//Display a success message
			$("#modalUser{{message.message_id}}").val("");
			$("#message{{message.message_id}}").html("");
			$("#myModal{{message.message_id}}").modal('hide');
			$('.modal-backdrop').fadeOut(50);
			$("#messageSent").html('');
			$("#messageSent").css("display", "block");
			$("#messageSent").html(result);
			$("#messageSent").delay(5000).fadeOut();
		});//close the Ajax call
	}//close the reply function

	$('.replyButton').click(reply);
</script>

{% endblock %}