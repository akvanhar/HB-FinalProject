{% extends 'base.html' %}
{% block content %}
<script>
	$("#messagesButton").attr("class", 'active');
</script>

<h3>New Messages:</h3>
<div id="messageSent" class="alert alert-success" role="alert" style="display: none"></div>
{% if all_messages %}
	<table class="table table-condensed table-hover">
		<thead>
			<tr>
				<th>Date Sent:</th>
				<th>Message From:</th>
				<th>Message</th>
				<th></th>
				<th></th>
			</tr>
		</thead>
		<tbody id="messageTable">
			{% for message in all_messages %}
				<tr id='message{{ message.message_id }}'>
				{% if message.read_status == 0 %}
					<td class='unReadMessage'>{{ message.datetime_sent.strftime("%b %d, %Y") }}</td>
					<td class='unReadMessage'>{{ message.user.fname }} {{ message.user.lname }}</td>
					<td class='unReadMessage'>{{ message.message_sent }}</td>	
				{% else %}
					<td class='readMessage'>{{ message.datetime_sent.strftime("%b %d, %Y") }}</td>
					<td class='readMessage'>{{ message.user.fname }} {{ message.user.lname }}</td>
					<td class='readMessage'>{{ message.message_sent }}</td>
				{% endif %}
					<td>
						<button id = "reply{{message.message_id}}" class="btn btn-sm" data-toggle="modal" data-target="#myModal{{message.message_id}}">Reply</button>
						<div class="replyModal modal fade" id="myModal{{message.message_id}}" tabindex="-1" role="dialog">
							<div class="modal-dialog" role="document">
    							<div class="modal-content">
        							<div class="modal-header">
            							<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            							<h1 id="header{{message.message_id}}" class="modalHeader modal-title">Reply to {{ message.user.fname }}:</h1>
        							</div>
    								<div class="modal-body">
    									<p>Original message: {{ message.message_sent }}</p>
    									<form action="/reply_to_message" methods="post" class="modalForm" id='replyTo{{ message.message_id }}'>
        									<input class="modalUser" id="modalUser{{message.message_id}}" type="hidden" name="send_message_to" value="{{ message.user.user_id }}">
											<textarea class="modalTextArea" id="textArea{{message.message_id}}" name='message' rows='10' cols='75'></textarea>
    								</div>
    								<div class="modal-footer">
        								<button class="modalCancel btn btn-default" data-dismiss="modal">Cancel</button>
        								<button class="modalSubmit btn btn-primary pull-right" data-id='submit{{ message.message_id }}'>Reply</button>	
    								</div>
    								</form>
								</div>
							</div>
						</div>
					</td>
					<td><button class="deleteButton btn btn-sm" data-id='delete{{ message.message_id }}'>Delete</button></td>
					{% if message.read_status == 0%}
						<td><button data-id='read{{ message.message_id }}' class="readButton btn btn-sm">Mark as read</button></td>
					{% else %}
						<td><button data-id='unread{{ message.message_id }}' class="unreadButton btn btn-sm">Mark as unread</button></td>
					{% endif %}
				</tr>
			{% endfor %}

		</tbody>
	</table>
{% else %}
	<p>You have new messages</p>
{% endif %}
<script>
	function deleteMessage(evt) {
		//delete the user message and display success message
		targetMessage = $(evt.currentTarget).data().id;
		var thisMessage = targetMessage.slice(6);
		var messageId = { message_id: thisMessage };
		$.post("/delete_message", messageId, function (result) {
			$("#messageSent").html('');
			$("#messageSent").css("display", "block");
			$("#messageSent").html('Your message has been deleted.');
			$("#messageSent").delay(3000).fadeOut();
			$("#message"+thisMessage).remove();
			});
	}
	$('.deleteButton').click(deleteMessage);

	function reply(evt) {
		//submit the form to the server and close the modal window
		evt.preventDefault();
		targetModal = $(evt.currentTarget).data().id;
		var thisModal = targetModal.slice(6);
		messageInfo = $("#replyTo"+thisModal).serialize();

		$.post("/reply_to_message", messageInfo, function (result) {
					// 	//Display a success message
			$("#textArea"+thisModal).val("");
			$("#myModal"+thisModal).modal('hide');
			$("#messageSent").html('');
			$("#messageSent").css("display", "block");
			$("#messageSent").html(result);
			$("#messageSent").delay(3000).fadeOut();
			});//close the Ajax call
	}//close the reply function

	$('.modalSubmit').click(reply);

	function markAsRead(evt) {
		targetReadMessage = $(evt.currentTarget).data().id;
		var thisReadMessageId = targetReadMessage.slice(4);
		var readMessageId = { message_id: thisReadMessageId };
		$.post("/mark_as_read", readMessageId, function (result) {
			$("#messageSent").html('');
			$("#messageSent").css("display", "block");
			$("#messageSent").html('Your message has been marked as read.');
			$("#messageSent").delay(3000).fadeOut();

		});
	}

	$('.readButton').click(markAsRead);

	function markAsUnread(evt) {
		targetUnReadMessage = $(evt.currentTarget).data().id;
		var thisUnReadMessageId = targetUnReadMessage.slice(6);
		var unReadMessageId = { message_id: thisUnReadMessageId };

		$.post("/mark_as_unread", unReadMessageId, function (result) {
			$("#messageSent").html('');
			$("#messageSent").css("display", "block");
			$("#messageSent").html('Your message has been marked as read.');
			$("#messageSent").delay(3000).fadeOut();
		});
	}

	$('.unreadButton').click(markAsUnread);
</script>

{% endblock %}